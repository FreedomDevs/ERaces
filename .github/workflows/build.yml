name: Build and Release on Version Change

on:
  push:
    branches:
      - master

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      version_after: ${{ steps.check.outputs.version_after }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check version change in build.gradle.kts
        id: check
        run: |
          # Получаем build.gradle.kts из предыдущего коммита
          git show HEAD~1:build.gradle.kts > old_build.gradle.kts

          # Извлекаем версию из старого файла
          version_before=$(grep -Po '(?<=version\s*=\s*")[^"]*' old_build.gradle.kts || echo "undefined")

          # Извлекаем версию из текущего файла
          version_after=$(grep -Po '(?<=version\s*=\s*")[^"]*' build.gradle.kts || echo "undefined")

          echo "version_before=$version_before"
          echo "version_after=$version_after"

          if [ "$version_before" != "$version_after" ]; then
            echo "::set-output name=changed::true"
          else
            echo "::set-output name=changed::false"
          fi

          echo "::set-output name=version_after::$version_after"

  build_and_release:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build project with Gradle
        run: ./gradlew clean build

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version-change.outputs.version_after }}
          name: Release v${{ needs.check-version-change.outputs.version_after }}
          body: |
            Автоматический релиз версии ${{ needs.check-version-change.outputs.version_after }}

            Последние коммиты:
            $(git log --pretty=format:"- %s" HEAD~5..HEAD)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JAR artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          files: build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
